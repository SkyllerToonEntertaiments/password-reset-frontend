<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Redefinir senha</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3E%F0%9F%94%92%3C/text%3E%3C/svg%3E">
  <style>
    :root{--bg:#f7fafc;--card:#fff;--accent:#0f172a;--muted:#64748b}
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;padding:24px;background:var(--bg);color:var(--accent)}
    .container{max-width:480px;margin:40px auto;background:var(--card);padding:28px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.08)}
    h1{margin:0 0 10px;font-size:20px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    label{display:block;margin-top:12px;font-size:13px;color:var(--muted)}
    input[type="password"], input[type="text"]{width:100%;padding:10px 12px;margin-top:6px;border:1px solid #e6eef8;border-radius:8px;font-size:14px;background:#fbfdff}
    button{margin-top:18px;padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}
    button[disabled]{opacity:0.6;cursor:not-allowed}
    .msg{margin-top:14px;padding:10px;border-radius:8px}
    .msg.success{background:#ecfdf5;color:#065f46}
    .msg.error{background:#fff1f2;color:#9f1239}
    .hint{font-size:13px;color:var(--muted);margin-top:10px}
    .small{font-size:13px;color:var(--muted)}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="container">
    <h1>Redefinir sua senha</h1>
    <p class="lead">Se o link contiver <code>#access_token=...</code>, a página detecta automaticamente.</p>

    <label for="urlInput">Link de reset (opcional)</label>
    <input id="urlInput" type="text" placeholder="Cole a URL do e-mail aqui" />

    <div id="tokenNotice" class="hint hidden">Token detectado — insira e confirme a nova senha.</div>

    <div id="pwForm" class="hidden">
      <label for="newPassword">Nova senha</label>
      <input id="newPassword" type="password" autocomplete="new-password" />
      <label for="confirmPassword">Confirmar nova senha</label>
      <input id="confirmPassword" type="password" autocomplete="new-password" />
      <button id="submitBtn">Redefinir senha</button>
      <div id="message" class="msg hidden"></div>
      <div id="finalNote" class="small hidden">✅ Senha alterada com sucesso. Agora você pode fazer login.</div>
    </div>

    <div id="noToken" class="hidden">
      <p class="small">Token não encontrado. Solicite um novo link de recuperação.</p>
    </div>
  </div>

  <script>
    (async function () {
      const SUPABASE_URL = 'https://hidlpxxbovmqrqgikess.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhpZGxweHhib3ZtcXJxZ2lrZXNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMTU5NDQsImV4cCI6MjA3NjY5MTk0NH0.auN-zYkqqBzSdcdHsOGU-PciX6LZiF19dtPmPOYZCZA';

      const $ = id => document.getElementById(id);
      const show = el => el.classList.remove('hidden');
      const hide = el => el.classList.add('hidden');
      const setMsg = (text, type='error') => {
        const m = $('message');
        m.textContent = text;
        m.className = 'msg ' + (type === 'success' ? 'success' : 'error');
        show(m);
      };

      function extractToken() {
        const url = new URL(location.href);
        //  ✅ Agora lê token no hash (#)
        const hashParams = new URLSearchParams(location.hash.slice(1));
        const token = hashParams.get('access_token');
        const type = hashParams.get('type');
        return (type === 'recovery' && token) ? token : null;
      }

      async function updateSession(token) {
        // ✅ Essencial para Supabase aceitar reset
        await fetch(SUPABASE_URL + '/auth/v1/token?grant_type=password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': 'B
