<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Redefinir senha</title>
  <!-- Favicon embutido (data URL) para evitar 404 /favicon.ico -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3E%F0%9F%94%92%3C/text%3E%3C/svg%3E">
  <style>
    :root{--bg:#f7fafc;--card:#fff;--accent:#0f172a;--muted:#64748b}
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;padding:24px;background:var(--bg);color:var(--accent)}
    .container{max-width:480px;margin:40px auto;background:var(--card);padding:28px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.08)}
    h1{margin:0 0 10px;font-size:20px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    label{display:block;margin-top:12px;font-size:13px;color:var(--muted)}
    input[type="password"], input[type="email"], input[type="text"]{width:100%;padding:10px 12px;margin-top:6px;border:1px solid #e6eef8;border-radius:8px;font-size:14px;background:#fbfdff}
    button{margin-top:18px;padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}
    button[disabled]{opacity:0.6;cursor:not-allowed}
    .msg{margin-top:14px;padding:10px;border-radius:8px}
    .msg.success{background:#ecfdf5;color:#065f46}
    .msg.error{background:#fff1f2;color:#9f1239}
    .hint{font-size:13px;color:var(--muted);margin-top:10px}
    .small{font-size:13px;color:var(--muted)}
    .hidden{display:none}
    .top-config{margin-bottom:14px;padding:10px;border-radius:8px;background:#f1f5f9}
    .top-config input{width:100%;font-size:13px;padding:8px;border-radius:6px;border:1px solid #e2e8f0}
  </style>
</head>
<body>
  <div class="container">
    <h1>Redefinir sua senha</h1>
    <p class="lead">Cole o link que recebeu por e-mail aqui ou abra o link diretamente. Se o link contiver <code>?access_token=...</code>, a página já deve ler automaticamente.</p>

    <!-- CONFIG: campo para colar sua ANON KEY (apenas para testes rápidos) -->
    <div class="top-config">
      <label for="anonKeyInput" class="small">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhpZGxweHhib3ZtcXJxZ2lrZXNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMTU5NDQsImV4cCI6MjA3NjY5MTk0NH0.auN-zYkqqBzSdcdHsOGU-PciX6LZiF19dtPmPOYZCZA</label>
      <input id="anonKeyInput" type="text" placeholder="Cole sua SUPABASE_ANON_KEY aqui (ex: eyJ...)" />
      <div class="hint">Dica: em produção, use variáveis de ambiente do seu host em vez de colar a ANON KEY no frontend.</div>
    </div>

    <!-- Campo para testar/colar a URL (opcional) -->
    <label for="urlInput">Link de reset (opcional)</label>
    <input id="urlInput" type="text" placeholder="Cole a URL do e-mail aqui (ou deixe em branco)" />
    <div id="tokenNotice" class="hint hidden">Token detectado — prossiga para redefinir a senha.</div>
    <div id="pwForm" class="hidden">
      <label for="newPassword">Nova senha</label>
      <input id="newPassword" type="password" autocomplete="new-password" />
      <label for="confirmPassword">Confirmar nova senha</label>
      <input id="confirmPassword" type="password" autocomplete="new-password" />
      <button id="submitBtn">Redefinir senha</button>
      <div id="message" class="msg hidden"></div>
      <div id="finalNote" class="small hidden">Senha alterada com sucesso. Você pode agora entrar com a nova senha.</div>
    </div>
    <div id="noToken" class="hidden">
      <p class="small">Se você não tem um link, solicite um novo reset pela sua página de "esqueci minha senha".</p>
    </div>
  </div>

  <script>
    (function () {
      // CONFIG: URL do projeto Supabase (ajuste se necessário)
      const SUPABASE_URL = 'https://hidlpxxbovmqrqgikess.supabase.co';

      // Helper: exibe mensagens
      const $ = id => document.getElementById(id);
      const show = (el) => el.classList.remove('hidden');
      const hide = (el) => el.classList.add('hidden');
      const setMsg = (text, type='error') => {
        const m = $('message');
        m.textContent = text;
        m.className = 'msg ' + (type === 'success' ? 'success' : 'error');
        show(m);
      };

      // Lê token da query string
      function getAccessTokenFromURL(urlString) {
        try {
          const u = urlString ? new URL(urlString, location.origin) : new URL(location.href);
          return u.searchParams.get('access_token') || null;
        } catch (e) {
          return null;
        }
      }

      // Função que chama Supabase Auth para atualizar senha usando token
      async function resetPasswordWithToken(accessToken, password, anonKey) {
        if (!SUPABASE_URL) throw new Error('SUPABASE_URL não configurado.');
        // Preferimos usar o endpoint /auth/v1/user com Authorization Bearer <access_token>
        const endpoint = SUPABASE_URL.replace(/\/$/, '') + '/auth/v1/user';
        // Se você quiser usar a lib supabase-js, é necessário inicializá-la com anonKey.
        // Aqui vamos fazer a requisição direta com Authorization Bearer <token>.
        const res = await fetch(endpoint, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + accessToken,
            'Accept': 'application/json'
          },
          body: JSON.stringify({ password })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = data?.error_description || data?.error || data?.message || 'Erro ao redefinir a senha.';
          throw new Error(msg);
        }
        return data;
      }

      // Inicialização
      const anonKeyInput = $('anonKeyInput');
      const urlInput = $('urlInput');
      const pwForm = $('pwForm');
      const noToken = $('noToken');
      const tokenNotice = $('tokenNotice');
      const submitBtn = $('submitBtn');
      const newPassword = $('newPassword');
      const confirmPassword = $('confirmPassword');
      const finalNote = $('finalNote');

      // Lê token inicialmente da URL
      let token = getAccessTokenFromURL();
      if (token) {
        urlInput.value = location.href;
        show(tokenNotice);
        show(pwForm);
      } else {
        show(noToken);
      }

      // Se usuário colar uma URL manualmente
      urlInput.addEventListener('change', (e) => {
        const v = e.target.value.trim();
        const t = getAccessTokenFromURL(v);
        if (t) {
          token = t;
          show(tokenNotice);
          show(pwForm);
          hide(noToken);
        } else {
          token = null;
          hide(tokenNotice);
          hide(pwForm);
          show(noToken);
        }
      });

      // Validação de senha simples
      function validatePasswords(pw, pw2) {
        if (!pw || pw.length < 8) return 'A senha deve ter ao menos 8 caracteres.';
        if (pw !== pw2) return 'As senhas não conferem.';
        return null;
      }

      submitBtn.addEventListener('click', async () => {
        hide($('message'));
        if (!token) {
          setMsg('Token não encontrado. Cole a URL completa recebida por e-mail e tente novamente.');
          return;
        }
        const anonKey = anonKeyInput.value.trim();
        if (!anonKey) {
          setMsg('Cole a SUPABASE_ANON_KEY no campo acima antes de prosseguir.');
          return;
        }
        const pw = newPassword.value.trim();
        const pw2 = confirmPassword.value.trim();
        const vErr = validatePasswords(pw, pw2);
        if (vErr) {
          setMsg(vErr);
          return;
        }
        submitBtn.disabled = true;
        submitBtn.textContent = 'Aguarde...';
        try {
          // Chamada direta ao endpoint Auth para trocar a senha com o access_token
          const result = await resetPasswordWithToken(token, pw, anonKey);
          // Sucesso
          setMsg('Senha alterada com sucesso!', 'success');
          show(finalNote);
          newPassword.value = '';
          confirmPassword.value = '';
        } catch (err) {
          setMsg(err.message || String(err));
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Redefinir senha';
        }
      });

      // Validação rápida no enter
      [newPassword, confirmPassword].forEach(el => {
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') submitBtn.click();
        });
      });

      // Pequena checagem visual: se a ANON KEY estiver vazia, mostra aviso
      anonKeyInput.addEventListener('input', () => {
        const hintId = 'anonHint';
        let hint = document.getElementById(hintId);
        if (!anonKeyInput.value.trim()) {
          if (!hint) {
            hint = document.createElement('div');
            hint.id = hintId;
            hint.className = 'hint';
            hint.style.marginTop = '8px';
            hint.textContent = 'Campo ANON KEY está vazio — cole sua SUPABASE_ANON_KEY para poder finalizar o reset.';
            document.querySelector('.top-config').appendChild(hint);
          }
        } else {
          const h = document.getElementById(hintId);
          if (h) h.remove();
        }
      });

      // Caso queira, detecta se a página foi aberta com access_token e preenche automaticamente.
      // (Já feito no início)

    })();
  </script>
</body>
</html>
