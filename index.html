<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  const SUPABASE_URL = 'https://hidlpxxbovmqrqgikess.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhpZGxweHhib3ZtcXJxZ2lrZXNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMTU5NDQsImV4cCI6MjA3NjY5MTk0NH0.auN-zYkqqBzSdcdHsOGU-PciX6LZiF19dtPmPOYZCZA'; // COLOQUE A SUA ✅

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = id => document.getElementById(id);
  const show = el => el.classList.remove('hidden');
  const hide = el => el.classList.add('hidden');
  const setMsg = (text, type='error') => {
    const m = $('message');
    m.textContent = text;
    m.className = 'msg ' + (type === 'success' ? 'success' : 'error');
    show(m);
  };

  function getToken(urlString) {
    try {
      const u = urlString ? new URL(urlString, location.origin) : new URL(location.href);
      return u.searchParams.get('access_token');
    } catch { return null; }
  }

  const urlInput = $('urlInput');
  const pwForm = $('pwForm');
  const tokenNotice = $('tokenNotice');
  const noToken = $('noToken');
  const submitBtn = $('submitBtn');
  const newPassword = $('newPassword');
  const confirmPassword = $('confirmPassword');
  const finalNote = $('finalNote');

  let token = getToken();

  if (token) {
    urlInput.value = location.href;
    show(tokenNotice);
    show(pwForm);
  } else {
    show(noToken);
  }

  urlInput.addEventListener('change', (e) => {
    token = getToken(e.target.value.trim());
    if (token) {
      hide(noToken);
      show(tokenNotice);
      show(pwForm);
    } else {
      hide(tokenNotice);
      hide(pwForm);
      show(noToken);
    }
  });

  function validate(pw, pw2) {
    if (!pw || pw.length < 8) return 'A senha deve ter ao menos 8 caracteres.';
    if (pw !== pw2) return 'As senhas não conferem.';
    return null;
  }

  submitBtn.addEventListener('click', async () => {
    hide($('message'));

    if (!token) return setMsg('Token não encontrado.');

    const pw = newPassword.value.trim();
    const pw2 = confirmPassword.value.trim();

    const err = validate(pw, pw2);
    if (err) return setMsg(err);

    submitBtn.disabled = true;
    submitBtn.textContent = 'Aguarde...';

    try {
      // ✅ Aqui a mágica: o SDK usa o token automaticamente da URL!
      const { error } = await supabase.auth.updateUser({
        password: pw
      });

      if (error) throw error;

      setMsg('Senha alterada com sucesso!', 'success');
      show(finalNote);
      newPassword.value = confirmPassword.value = '';
    } catch (e) {
      setMsg(e.message);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Redefinir senha';
    }
  });
</script>
