<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset de Senha - Teste Supabase</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 24px; max-width: 720px; margin: auto; }
    input, button { font-size: 16px; padding: 8px; margin: 6px 0; width: 100%; box-sizing: border-box; }
    .hidden { display: none; }
    .msg { margin: 8px 0; padding: 10px; border-radius: 6px; }
    .success { background: #e6ffed; color: #037a3b; }
    .error { background: #ffe6e6; color: #9b1c1c; }
  </style>
</head>
<body>
  <h1>Reset de Senha (Teste)</h1>

  <div id="status" class="msg"></div>

  <!-- Formulário opcional para solicitar email de reset -->
  <div id="request-reset">
    <h2>Solicitar link de reset</h2>
    <input id="email-request" type="email" placeholder="Seu email" />
    <button id="btn-request">Enviar link de reset</button>
  </div>

  <!-- Form de nova senha (aparece se houver token na URL) -->
  <div id="set-password" class="hidden">
    <h2>Definir nova senha</h2>
    <input id="new-password" type="password" placeholder="Nova senha" />
    <input id="confirm-password" type="password" placeholder="Confirmar nova senha" />
    <button id="btn-set">Definir senha</button>
  </div>

  <script type="module">
    // ----- CONFIGURE AQUI: cole sua ANON KEY entre aspas -----
    const SUPABASE_URL = 'https://hidlpxxbovmqrqgikess.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhpZGxweHhib3ZtcXJxZ2lrZXNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMTU5NDQsImV4cCI6MjA3NjY5MTk0NH0.auN-zYkqqBzSdcdHsOGU-PciX6LZiF19dtPmPOYZCZA';
    // ---------------------------------------------------------

    // Validações básicas
    if (!SUPABASE_URL || SUPABASE_URL.includes('hidlpxxbovmqrqgikess') && SUPABASE_ANON_KEY === 'COLE_AQUI_SUA_ANON_KEY') {
      document.getElementById('status').className = 'msg error';
      document.getElementById('status').textContent = 'Erro: cole sua SUPABASE_ANON_KEY no arquivo antes de testar.';
      throw new Error('Missing ANON KEY');
    }

    // Import ligero do supabase-js via CDN (compatível para teste rápido).
    // Em produção, prefira instalar via npm e usar build.
    import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm').then(({ createClient }) => {
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const statusEl = document.getElementById('status');
      const setPasswordEl = document.getElementById('set-password');
      const requestResetEl = document.getElementById('request-reset');

      // Ler access_token da URL
      const url = new URL(window.location.href);
      const accessToken = url.searchParams.get('access_token');

      function showMessage(text, type = 'success') {
        statusEl.className = 'msg ' + (type === 'error' ? 'error' : 'success');
        statusEl.textContent = text;
      }

      // Se tiver token, troque sessão e permita definir nova senha
      (async function handleToken() {
        if (!accessToken) {
          // Sem token: mostrar opção de solicitar reset
          requestResetEl.classList.remove('hidden');
          setPasswordEl.classList.add('hidden');
          showMessage('Sem token de reset na URL. Você pode solicitar um link de reset abaixo.');
          return;
        }

        showMessage('Token detectado. Validando...');

        // Tenta setar a sessão usando o token (isso autentica o usuário temporariamente)
        const { data, error } = await supabase.auth.setSession({ access_token: accessToken });

        if (error) {
          showMessage('Erro ao validar token: ' + (error.message || error), 'error');
          // Ainda permitir solicitar novo reset
          requestResetEl.classList.remove('hidden');
          setPasswordEl.classList.add('hidden');
          return;
        }

        // Sessão válida -> mostrar formulário para nova senha
        showMessage('Token validado. Preencha a nova senha abaixo.');
        setPasswordEl.classList.remove('hidden');
        requestResetEl.classList.add('hidden');
      })();

      // Handler: solicitar envio de link de reset por email
      document.getElementById('btn-request').addEventListener('click', async () => {
        const email = document.getElementById('email-request').value.trim();
        if (!email) return showMessage('Informe um email válido.', 'error');

        showMessage('Enviando link de reset...');
        const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.origin // opcional: define onde o link deve redirecionar
        });

        if (error) {
          showMessage('Erro ao enviar link: ' + (error.message || error), 'error');
        } else {
          showMessage('Link de reset enviado (verifique seu email).');
        }
      });

      // Handler: definir nova senha (usuário já autenticado via token)
      document.getElementById('btn-set').addEventListener('click', async () => {
        const pwd = document.getElementById('new-password').value;
        const pwd2 = document.getElementById('confirm-password').value;
        if (!pwd || pwd.length < 6) return showMessage('Senha precisa ter pelo menos 6 caracteres.', 'error');
        if (pwd !== pwd2) return showMessage('As senhas não conferem.', 'error');

        showMessage('Alterando senha...');
        // Usamos updateUser (v2) para atualizar a senha do usuário autenticado
        const { data, error } = await supabase.auth.updateUser({ password: pwd });

        if (error) {
          showMessage('Erro ao alterar senha: ' + (error.message || error), 'error');
        } else {
          showMessage('Senha alterada com sucesso. Você está autenticado.');
          // Opcional: redirecionar para dashboard
          // window.location.href = '/dashboard';
        }
      });

    }).catch((err) => {
      document.getElementById('status').className = 'msg error';
      document.getElementById('status').textContent = 'Erro ao carregar supabase-js: ' + err;
      console.error(err);
    });

  </script>
</body>
</html>
